# Архитектура децентрализованной вычислительной сети

Документ описывает целевую архитектуру, обеспечивающую полностью децентрализованное исполнение задач, сильную криптографическую защиту и совместимость клиентов на разных платформах.

## 1. Слои системы

```
┌──────────────────────────────────────────────────────────┐
│        Клиенты (CLI, Python SDK, REST/WebSocket API)     │
├──────────────────────────────────────────────────────────┤
│      Контроллер задач и кредитов (Task / Credit Plane)   │
├──────────────────────────────────────────────────────────┤
│      Равноправные узлы синхронизации (P2P Overlay)        │
├──────────────────────────────────────────────────────────┤
│  Шифрование, удостоверения, управление идентичностями     │
├──────────────────────────────────────────────────────────┤
│            Песочницы исполнения (Sandbox Layer)          │
└──────────────────────────────────────────────────────────┘
```

## 2. Сеть и полная децентрализация
- **Overlay:** каждый узел поддерживает безопасные TCP + QUIC каналы с соседями. Discovery реализуется через Kademlia DHT и локальные broadcast'ы, поэтому нет центральных координационных серверов.
- **Consensus-lite:** для синхронизации состояний (кредиты, список задач) используется набор CRDT‑структур и обмен событий через gossip. Нет единой точки отказа.
- **Zero-trust модель:** каждое действие подписывается приватным ключом узла, а подписи проверяются всеми получателями.

## 3. Криптография и безопасность
- **Идентичности:** ключи Ed25519/Curve25519. Публичные ключи являются идентификаторами узлов.
- **Каналы:** TLS 1.3 поверх QUIC/TCP + дополнительное Double Ratchet шифрование для обмена задачами и результатами.
- **Хранение секретов:** приватные ключи шифруются локальным KMS (например, libsodium + passphrase) и никогда не покидают машину.
- **Подписи задач:** payload задачи (описание, ресурсы, лимиты) подписывается отправителем, воркеры подписывают результаты.
- **Sandbox:** процессная изоляция по умолчанию, опционально container или WebAssembly. Ограничены CPU/RAM/FS/Network. Все вызовы происходят через audited API.

## 4. Универсальные клиенты
- **CLI:** команда `p2pctl` (в разработке) управляет локальным демоном и задачами.
- **Python SDK:** `src/main.py` экспонирует высокоуровневый API (`ComputeNetwork`) для интеграций.
- **Web/API:** REST/WebSocket шлюз (планируется) подключается к локальному узлу и повторно использует ту же криптографию, поэтому можно строить браузерные/мобильные клиенты.
- **Формат сообщений:** JSON/MessagePack с versioning + protobuf схемы, поэтому клиенты на любых языках совместимы.

## 5. Контур задач и кредитов
1. **Подача:** клиент формирует `Task`, подписывает и публикует в сеть.
2. **Маркет:** узлы обмениваются метриками ресурсов и ценами. `DynamicPricingEngine` выбирает оптимального исполнителя.
3. **Эскроу кредитов:** `CreditManager` резервирует compute‑кредиты владельца на период выполнения задачи. Перевод происходит только после подтверждённого результата.
4. **Исполнение:** воркер запускает задачу в песочнице, собирает метрики, подписывает отчёт.
5. **Валидация:** координаторы-пиры проверяют подписи и репутацию, после чего результаты передаются владельцу.
6. **Репутация:** каждое событие (`task_success`, `cheat_detected`, …) попадает в `ReputationManager`; баллы влияют на цены и доступ к срочным задачам.

## 6. Масштабируемость и устойчивость
- **Hot-sharding:** задачи делятся на чанки и могут исполняться на разных воркерах параллельно.
- **Failover:** если воркер пропал, задача автоматически перераспределяется. При таймауте кредиты возвращаются владельцу, воркер получает штраф.
- **Телееметрия:** `network_health_checker` объединяет статистику по ресурсам, репутации и кредитам, что позволяет обнаруживать аномалии.

## 7. Путь данных

```
Client SDK ──signed Task──► Local Node ──gossip──► Eligible Peers
Eligible Peer ──sandbox exec──► Result ──signature──► Network
Network ──validation + escrow settlement──► Client SDK
```

## 8. Минимальный набор сервисов, который нужно поднять
| Компонент                    | Назначение                                    |
|-----------------------------|-----------------------------------------------|
| `ComputeNode`               | Узел P2P overlay и выполнение задач           |
| `ComputeNetwork`            | Планировщик, рынок, управление кредитами      |
| `SandboxExecutor`           | Изоляция задач (process/wasm/container)       |
| `ReputationManager`         | Учёт действий узлов                           |
| `CreditManager`             | Транзакции compute-кредитов                   |
| `DynamicPricingEngine`      | Ценообразование и выбор воркеров              |

Этот дизайн обеспечивает требуемые пользователем свойства: нет центров управления, данные и каналы защищены современной криптографией, а клиенты могут подключаться из любых сред благодаря общей схеме идентификации и обмена сообщениями.
